# 数据库架构设计说明

## 数据库角色分析

### 向量数据库 vs SQL 数据库

#### 向量数据库（ChromaDB）的作用
- ✅ **核心功能**：RAG 语义搜索
  - 存储文档块（chunks）的向量嵌入
  - 快速相似度搜索
  - 检索相关文档片段用于 LLM 上下文
- ✅ **元数据存储**：ChromaDB 支持元数据过滤
  - 文档ID、文件名、创建时间、标签等
  - 可以基于元数据进行筛选

#### SQL 数据库的必要性分析

**如果只使用向量数据库，可以满足：**
- ✅ 文档语义搜索（RAG）
- ✅ 文档元数据存储（文件名、时间、标签）
- ✅ 文档CRUD操作（ChromaDB支持）

**SQL 数据库仍然有用的场景：**
- ⚠️ **笔记文件管理**：Obsidian 笔记是文件系统级别的，需要跟踪文件路径、修改时间
- ⚠️ **双向链接追踪**：需要快速查询哪些笔记链接到某个笔记
- ⚠️ **复杂查询**：如"查找所有未链接的笔记"、"统计笔记数量"等
- ⚠️ **事务支持**：文件操作的原子性

**简化方案建议：**

### 方案 A：纯向量数据库（最简化）
- **使用 ChromaDB 存储所有数据**
  - 文档向量 + 元数据
  - 笔记内容（作为特殊类型的文档）
  - 文件系统同步：笔记文件直接存储在文件系统中，通过文件系统监听同步到 ChromaDB
- **优点**：架构简单，部署简单
- **缺点**：复杂查询性能可能不佳，文件系统操作需要额外同步逻辑

### 方案 B：轻量级 SQL + 向量数据库（推荐）
- **SQLite**：仅存储笔记元数据和关系
  - 笔记路径、修改时间、文件大小
  - 笔记之间的链接关系（双向链接）
  - 简单的统计查询
- **ChromaDB**：存储所有向量嵌入
  - 文档块向量
  - 笔记内容向量（用于RAG）
- **优点**：查询性能好，支持复杂关系查询
- **缺点**：需要维护两个数据库

### 方案 C：纯文件系统 + 向量数据库（最轻量）
- **文件系统**：直接存储 Obsidian 笔记文件（.md）
- **ChromaDB**：
  - 文档向量（从PDF/URL处理）
  - 笔记内容向量（从.md文件读取）
  - 笔记元数据（从文件系统读取）
- **优点**：最简化，笔记可以直接用 Obsidian 打开
- **缺点**：查询性能依赖文件系统扫描

## 推荐方案：方案 C（纯文件系统 + 向量数据库）

**理由：**
1. **侧重点在 RAG**：向量数据库是核心，文件系统满足笔记管理
2. **Obsidian 兼容性**：直接使用 .md 文件，可以用 Obsidian 打开
3. **简化部署**：不需要 SQL 数据库，降低复杂度
4. **LLM 生成笔记**：生成的 .md 文件可以直接保存到文件系统

### 数据流设计

```
用户上传文档/URL
    ↓
文档处理服务（解析内容）
    ↓
文档分块 + 向量化
    ↓
ChromaDB（存储向量 + 元数据）
    ↓
RAG 检索（从 ChromaDB 查询相关文档）
    ↓
LLM 生成回答或生成 Obsidian 笔记
    ↓
保存为 .md 文件到文件系统
```

### 笔记管理流程

```
笔记文件（.md）存储在文件系统
    ↓
文件监听服务（可选）
    ↓
读取笔记内容，提取链接和元数据
    ↓
向量化笔记内容
    ↓
存储到 ChromaDB（用于RAG）
    ↓
索引笔记链接关系（内存/JSON文件）
```

## 实现要点

### 1. 向量数据库元数据设计

```python
# ChromaDB 文档元数据
{
    "doc_id": "uuid",
    "doc_type": "document|note",  # 区分文档和笔记
    "file_path": "/notes/my-note.md",  # 笔记文件路径
    "title": "笔记标题",
    "created_at": "2024-01-01T00:00:00",
    "tags": ["tag1", "tag2"],
    "source": "pdf|url|note",  # 来源
    "chunk_index": 0,  # 块索引
}
```

### 2. 笔记链接索引（可选）

如果不需要复杂的双向链接查询，可以：
- 直接从 .md 文件解析 `[[链接]]`
- 或使用简单的 JSON 文件存储链接关系

### 3. 文件系统结构

```
notes/
├── index.md           # 索引页
├── project-a/
│   ├── note1.md
│   └── note2.md
└── project-b/
    └── note3.md

documents/             # 上传的文档（可选）
├── doc1.pdf
└── doc2.pdf
```

## 总结

**对于 RAG 为重点的项目，建议：**
- ✅ **使用 ChromaDB** 作为唯一的数据存储（向量 + 元数据）
- ✅ **使用文件系统** 直接存储 Obsidian 笔记（.md 文件）
- ✅ **LLM 生成笔记** 直接保存为 .md 文件
- ❌ **不需要 SQL 数据库**（除非后续需要复杂的关系查询）

这样的架构更简单，更适合快速迭代和 LLM 应用开发。

